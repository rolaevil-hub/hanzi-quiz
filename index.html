<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åœ‹å­—å­—è©è¤‡ç¿’ï¼ˆç·šä¸Šç‰ˆï½œå¯åˆ†äº«é€£çµï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:"Microsoft JhengHei",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7f7;margin:0;color:#222}
    header{padding:16px;text-align:center;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    h1{margin:0;color:#4CAF50}
    main{max-width:980px;margin:20px auto;padding:0 12px 60px}
    .card{background:#fff;padding:16px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-bottom:16px}
    textarea{width:100%;height:140px;padding:8px;font-size:14px;border:1px solid #ccc;border-radius:10px}
    input[type="text"]{width:100%;padding:8px;border:1px solid #ccc;border-radius:10px}
    .btn{background:#4CAF50;color:#fff;padding:10px 14px;border:none;border-radius:10px;margin:6px 0;cursor:pointer}
    .btn:hover{filter:brightness(.95)}
    .btn.muted{background:#eee;color:#333}
    .btn.gray{background:#888}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    #options{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
    .opt{padding:12px;border:1.5px solid #e5e5e5;border-radius:12px;background:#fff;text-align:center;cursor:pointer}
    .opt:hover{border-color:#ccc}
    .opt.correct{border-color:#2ecc71;background:#effaf3}
    .opt.wrong{border-color:#e74c3c;background:#fff2f1}
    .muted{color:#666;font-size:13px}
    #quizSection{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:center}
    th{background:#fafafa}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.grid-2{grid-template-columns:1fr}}
    /* æˆç¸¾å½ˆçª— */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:20}
    .modal{width:min(520px,92vw);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:20px;text-align:center}
    .score{font-size:28px;margin:6px 0 12px}
    .badge{display:inline-block;background:#eef7ef;color:#185c27;border-radius:999px;padding:6px 12px;font-weight:700}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body>
  <header>
    <h1>åœ‹å­—å­—è©è¤‡ç¿’</h1>
    <div class="muted">æ”¯æ´ç¶²å€å¸¶é¡Œåº«ï½œéš¨æ©Ÿå‡ºé¡Œï½œå¯æ„›éŸ³æ•ˆï½œæˆç¸¾è¨˜éŒ„</div>
  </header>

  <main>
    <!-- é¡Œåº«è¼¸å…¥ / ç”¢ç”Ÿåˆ†äº«é€£çµ -->
    <section class="card" id="inputSection">
      <h3 style="margin-top:0">é¡Œåº«è¨­å®š</h3>
      <p class="muted">æ¯è¡Œï¼šã€Œ<span class="mono">è©èª ç©ºæ ¼ æ³¨éŸ³</span>ã€ï¼Œä¾‹å¦‚ï¼š<span class="mono">æ™æ‰ ã„“ã„¥ ã„“ã„šËŠ</span></p>
      <textarea id="wordInput">æ™æ‰ ã„“ã„¥ ã„“ã„šËŠ
å´¢å¶¸ ã„“ã„¥ ã„–ã„¨ã„¥ËŠ
æ“…è‡ª ã„•ã„¢Ë‹ ã„—Ë‹
é¡«æŠ– ã„“ã„¢Ë‹ ã„‰ã„¡Ë‡
å›‘å’ ã„“ã„¨Ë‡ ã„ˆã„¨Ë‹</textarea>
      <div class="row">
        <button class="btn" onclick="loadCustomWords()">è¼‰å…¥é¡Œåº«ï¼ˆé–‹å§‹ç·´ç¿’ï¼‰</button>
        <label class="muted right"><input type="checkbox" id="soundToggle" checked> ğŸ”ˆ å•Ÿç”¨éŸ³æ•ˆ</label>
      </div>
      <hr style="border:none;border-top:1px dashed #ddd;margin:12px 0">
      <div class="row">
        <button class="btn muted" onclick="makeShareLink()">ç”¢ç”Ÿåˆ†äº«é€£çµï¼ˆå…§åµŒé¡Œåº«ï¼‰</button>
        <input type="text" id="shareUrl" placeholder="ç”¢ç”Ÿå¾Œæœƒå‡ºç¾é€£çµï¼Œå¯è¤‡è£½åˆ†äº«" readonly>
        <button class="btn gray" onclick="copyShare()">è¤‡è£½</button>
      </div>
      <div>
        <p class="muted" style="margin:6px 0 4px"><b>æˆ–</b> ä½¿ç”¨å¤–éƒ¨æª”æ¡ˆç¶²å€ï¼ˆ<span class="mono">?src=</span>ï¼‰</p>
        <input type="text" id="srcUrl" placeholder="è²¼ä¸Šé¡Œåº«æ–‡å­—æª”ç¶²å€ï¼Œä¾‹å¦‚ GitHub Raw / Gist Raw / å­¸æ ¡ç¶²ç«™ç´”æ–‡å­—æª”" />
        <div class="row">
          <button class="btn muted" onclick="loadFromSrc()">ç”¨ç¶²å€è¼‰å…¥é¡Œåº«</button>
          <span class="muted">ç¶²å€éœ€å¯å…¬é–‹å­˜å–çš„ç´”æ–‡å­—ï¼ˆæ¯è¡Œä¸€é¡Œï¼‰</span>
        </div>
      </div>
    </section>

    <!-- æ¸¬é©— -->
    <section class="card" id="quizSection">
      <div class="row">
        <h3 id="question" style="margin:0">é¡Œç›®</h3>
        <label class="muted right"><input type="checkbox" id="soundToggle2" checked> ğŸ”ˆ éŸ³æ•ˆ</label>
      </div>
      <div id="options"></div>
      <p id="feedback" class="muted"></p>
      <div class="row">
        <button class="btn" id="nextBtn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
        <p class="muted right">åˆ†æ•¸ï¼š<span id="score">0</span></p>
      </div>
      <button class="btn muted" onclick="showInput()">é‡æ–°è¼‰å…¥é¡Œåº«</button>
    </section>

    <!-- æœ¬è¼ªæ‘˜è¦ï¼‹æ­·æ¬¡æˆç¸¾ -->
    <section class="grid-2">
      <div class="card">
        <h3 style="margin-top:0">æœ¬æ¬¡æ‘˜è¦</h3>
        <div id="summary" class="muted">è¼‰å…¥é¡Œåº«å¾Œé–‹å§‹ä½œç­”ï¼Œå®Œæˆæœƒåœ¨æ­¤é¡¯ç¤ºæˆç¸¾ã€‚</div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">æ­·æ¬¡æˆç¸¾ï¼ˆæœ€è¿‘ 10 æ¬¡ï¼‰</h3>
        <div class="row" style="margin-bottom:8px">
          <div class="muted">æœ€ä½³ï¼š<span id="bestBadge">â€”</span></div>
          <div class="right">
            <button class="btn muted" onclick="clearRecords()">æ¸…é™¤æˆç¸¾</button>
          </div>
        </div>
        <div id="recordsWrap" class="muted">å°šç„¡ç´€éŒ„</div>
      </div>
    </section>
  </main>

  <!-- çµæŸåˆ†æ•¸è¦–çª— -->
  <div class="overlay" id="endOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 style="margin:6px 0 2px">æœ¬è¼ªå®Œæˆï¼</h2>
      <div class="score" id="scoreLine">å¾—åˆ† 0/0ï¼ˆ0%ï¼‰</div>
      <div id="timeLine" class="muted" style="margin-bottom:12px">è€—æ™‚ 0 ç§’</div>
      <div id="badgeLine" class="badge">åŠ æ²¹ï¼å†è©¦ä¸€æ¬¡</div>
      <div style="margin-top:14px">
        <button class="btn" onclick="closeOverlayAndRestart()">å†ä¾†ä¸€è¼ªï¼ˆéš¨æ©Ÿï¼‰</button>
      </div>
    </div>
  </div>

<script>
/* ====== å·¥å…·ï¼šURL åƒæ•¸ ====== */
function getParam(name){
  const url = new URL(location.href);
  return url.searchParams.get(name);
}
function setParam(name,value){
  const url = new URL(location.href);
  if(value==null) url.searchParams.delete(name);
  else url.searchParams.set(name,value);
  history.replaceState(null, "", url.toString());
}

/* ====== ç‹€æ…‹ ====== */
let quizData = [];
let currentIndex = 0;
let score = 0;
let answered = false;
let startTs = 0;

/* ====== æˆç¸¾è¨˜éŒ„ï¼ˆlocalStorageï¼‰ ====== */
const STORAGE_KEY = "hanziQuizRecords_online_v1";
function loadRecords(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }catch{ return []; } }
function saveRecord(r){ const a=loadRecords(); a.unshift(r); while(a.length>10) a.pop(); localStorage.setItem(STORAGE_KEY, JSON.stringify(a)); }
function bestOf(rs){ if(!rs.length) return null; return rs.reduce((b,r)=>(r.correct/r.total)>(b.correct/b.total)?r:b); }
function renderRecords(){
  const records = loadRecords();
  const wrap = document.getElementById("recordsWrap");
  if(!records.length){ wrap.textContent="å°šç„¡ç´€éŒ„"; document.getElementById("bestBadge").textContent="â€”"; return; }
  wrap.innerHTML = `<table><thead><tr><th>æ™‚é–“</th><th>å¾—åˆ†</th><th>æ­£ç¢ºç‡</th><th>ç§’æ•¸</th></tr></thead><tbody>${
    records.map(r=>{
      const dt=new Date(r.time).toLocaleString();
      const acc=Math.round((r.correct/r.total)*100);
      return `<tr><td>${dt}</td><td>${r.correct}/${r.total}</td><td>${acc}%</td><td>${r.duration}s</td></tr>`;
    }).join("")
  }</tbody></table>`;
  const best = bestOf(records);
  if(best){
    const acc = Math.round((best.correct/best.total)*100);
    document.getElementById("bestBadge").textContent = `${best.correct}/${best.total}ï¼ˆ${acc}%ï¼‰æ–¼ ${new Date(best.time).toLocaleString()}`;
  }
}
function clearRecords(){ localStorage.removeItem(STORAGE_KEY); renderRecords(); }

/* ====== å¯æ„›éŸ³æ•ˆï¼ˆåŒå‰ä¸€ç‰ˆï¼‰ ====== */
let actx=null;
function ensureAudio(){ if(!actx) actx=new (window.AudioContext||window.webkitAudioContext)(); if(actx.state==="suspended") actx.resume(); }
function soundEnabled(){ const a=document.getElementById('soundToggle')?.checked ?? true; const b=document.getElementById('soundToggle2')?.checked ?? true; return a&&b; }
function cuteTone(freq=523.25, duration=0.16, {gain=0.22, lp=7500, vibrato=6, depth=8, when=0}={}){
  if(!soundEnabled()) return;
  ensureAudio();
  const t0=actx.currentTime+when;
  const out=actx.createGain(), filt=actx.createBiquadFilter();
  filt.type="lowpass"; filt.frequency.value=lp;
  out.gain.setValueAtTime(0.0001,t0);
  const o1=actx.createOscillator(); o1.type="triangle"; o1.frequency.setValueAtTime(freq,t0);
  const o2=actx.createOscillator(); o2.type="sine";     o2.frequency.setValueAtTime(freq*2,t0); o2.detune.value=+8;
  const lfo=actx.createOscillator(); lfo.type="sine"; lfo.frequency.value=vibrato;
  const lfoG=actx.createGain(); lfoG.gain.value=depth; lfo.connect(lfoG); lfoG.connect(o1.detune); lfoG.connect(o2.detune);
  out.gain.linearRampToValueAtTime(gain, t0+0.02);
  out.gain.exponentialRampToValueAtTime(Math.max(0.0001, gain*0.5), t0 + duration*0.6);
  out.gain.exponentialRampToValueAtTime(0.0001, t0 + duration);
  o1.connect(filt); o2.connect(filt); filt.connect(out).connect(actx.destination);
  o1.start(t0); o2.start(t0); lfo.start(t0);
  const stopAt=t0+duration+0.03; o1.stop(stopAt); o2.stop(stopAt); lfo.stop(stopAt);
}
function correctFx(){ cuteTone(783.99,0.15,{gain:0.22}); cuteTone(1046.50,0.17,{gain:0.20, when:0.12}); }
function wrongFx(){ cuteTone(329.63,0.18,{gain:0.18, lp:5200}); cuteTone(261.63,0.20,{gain:0.16, lp:4800, when:0.12}); }
function finishFx(){ cuteTone(1046.50,0.14,{gain:0.23}); cuteTone(1318.51,0.14,{gain:0.22, when:0.11}); cuteTone(1760.00,0.18,{gain:0.21, when:0.22}); cuteTone(2093.00,0.16,{gain:0.16, when:0.38}); }

/* ====== é¡Œåº«è™•ç† ====== */
function shuffle(a){ a=a.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function randomDistractors(correct){
  const b=["ã„…","ã„†","ã„‡","ã„ˆ","ã„‰","ã„Š","ã„‹","ã„Œ","ã„","ã„","ã„","ã„","ã„‘","ã„’","ã„“","ã„”","ã„•","ã„–","ã„—","ã„˜","ã„™","ã„š","ã„›","ã„œ","ã„","ã„","ã„Ÿ","ã„ ","ã„¡","ã„¢","ã„£","ã„¤","ã„¥","ã„¦","Ë‡","Ë‹","ËŠ","Ë™"];
  const d=[]; while(d.length<3){ let r=""; for(let i=0;i<correct.length;i++){ r+= (correct[i]===" "?" ": b[Math.floor(Math.random()*b.length)]); } if(!d.includes(r)&&r!==correct) d.push(r); }
  return d;
}
function parseLinesToQuiz(lines){
  return lines.map(line=>{
    const parts=line.trim().split(/\s+/);
    const word=parts[0]; const correct=parts.slice(1).join(" ");
    const opts=[correct, ...randomDistractors(correct)];
    return {word, correct, options: shuffle(opts)};
  });
}

/* ====== ä½œç­”æµç¨‹ ====== */
let TOTAL=0;
function loadCustomWords(){
  document.getElementById('soundToggle2').checked = document.getElementById('soundToggle').checked;
  const text=document.getElementById("wordInput").value.trim();
  const lines=text.split("\n").map(l=>l.trim()).filter(Boolean);
  quizData = shuffle(parseLinesToQuiz(lines));
  startQuiz();
}
async function loadFromSrc(){
  const url=document.getElementById("srcUrl").value.trim();
  if(!url){ alert("è«‹å…ˆè²¼ä¸Šé¡Œåº«æ–‡å­—æª”ç¶²å€"); return; }
  await loadFromSrcUrl(url);
}
async function loadFromSrcUrl(url){
  try{
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok){ throw new Error("ç„¡æ³•è®€å–é ç«¯é¡Œåº«"); }
    const text = await res.text();
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    quizData = shuffle(parseLinesToQuiz(lines));
    startQuiz();
  }catch(e){
    alert("è®€å–é¡Œåº«å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ç¶²å€ç„¡æ³•å…¬é–‹å­˜å–æˆ– CORS é™åˆ¶ï¼‰ã€‚\nå»ºè­°ä½¿ç”¨ GitHub Raw / Gist Raw / å­¸æ ¡ç¶²ç«™ç´”æ–‡å­—æª”ã€‚");
    console.error(e);
  }
}
function startQuiz(){
  currentIndex=0; score=0; answered=false;
  TOTAL=quizData.length;
  document.getElementById("score").textContent=score;
  document.getElementById("quizSection").style.display="block";
  document.getElementById("inputSection").style.display="none";
  document.getElementById("summary").textContent="ä½œç­”é€²è¡Œä¸­â€¦";
  startTs=Date.now();
  loadQuestion();
}
function showInput(){
  document.getElementById("quizSection").style.display="none";
  document.getElementById("inputSection").style.display="block";
  document.getElementById('soundToggle').checked = document.getElementById('soundToggle2').checked;
}
function loadQuestion(){
  answered=false;
  const q=quizData[currentIndex];
  document.getElementById("question").textContent=`ã€Œ${q.word}ã€çš„æ­£ç¢ºæ³¨éŸ³æ˜¯ï¼Ÿ";
  document.getElementById("feedback").textContent="";
  const optionsDiv=document.getElementById("options");
  optionsDiv.innerHTML="";
  shuffle(q.options).forEach(opt=>{
    const btn=document.createElement("button");
    btn.className="opt"; btn.textContent=opt;
    btn.onclick=()=>checkAnswer(opt,q.correct,btn);
    optionsDiv.appendChild(btn);
  });
}
function checkAnswer(selected, correct, btn){
  if(answered) return; answered=true;
  document.querySelectorAll(".opt").forEach(b=>{
    if(b.textContent===correct) b.classList.add("correct");
    else if(b===btn) b.classList.add("wrong");
    b.disabled=true;
  });
  if(selected===correct){ document.getElementById("feedback").textContent="âœ… ç­”å°äº†ï¼"; score++; document.getElementById("score").textContent=score; correctFx(); }
  else{ document.getElementById("feedback").textContent=`âŒ ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correct}`; wrongFx(); }
}
function nextQuestion(){
  if(!answered) return;
  currentIndex++;
  if(currentIndex>=quizData.length){ finishQuiz(); }
  else{ loadQuestion(); }
}
function finishQuiz(){
  const duration=Math.round((Date.now()-startTs)/1000);
  const acc=Math.round((score/TOTAL)*100);
  document.getElementById('scoreLine').textContent=`å¾—åˆ† ${score}/${TOTAL}ï¼ˆ${acc}%ï¼‰`;
  document.getElementById('timeLine').textContent=`è€—æ™‚ ${duration} ç§’`;
  const badge=document.getElementById('badgeLine');
  badge.textContent = acc===100 ? "æ»¿åˆ†ï¼å¤ªè®šäº†ï¼" : acc>=80 ? "è¡¨ç¾å¾ˆæ£’ï¼Œç¹¼çºŒä¿æŒï¼" : "åŠ æ²¹ï¼å†ç·´ä¸€æ¬¡æ›´ç†Ÿï¼";
  document.getElementById('endOverlay').style.display='flex';
  finishFx();
  document.getElementById("summary").textContent=`æœ¬è¼ªå®Œæˆï¼š${score}/${TOTAL}ï¼ˆ${acc}%ï¼‰ï¼Œè€—æ™‚ ${duration} ç§’ã€‚`;
  saveRecord({time:Date.now(), correct:score, total:TOTAL, duration});
  renderRecords();
}
function closeOverlayAndRestart(){
  document.getElementById('endOverlay').style.display='none';
  quizData = shuffle(quizData);
  currentIndex=0; score=0; document.getElementById("score").textContent=score;
  startTs=Date.now(); loadQuestion();
}

/* ====== ç”¢ç”Ÿåˆ†äº«é€£çµ ====== */
function base64urlEncode(str){
  return btoa(unescape(encodeURIComponent(str))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function base64urlDecode(str){
  str=str.replace(/-/g,'+').replace(/_/g,'/'); const pad=str.length%4? '='.repeat(4-(str.length%4)) : ''; return decodeURIComponent(escape(atob(str+pad)));
}
function makeShareLink(){
  const raw=document.getElementById("wordInput").value.trim();
  if(!raw){ alert("è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥é¡Œåº«æ–‡å­—"); return; }
  const enc=base64urlEncode(raw);
  const url=new URL(location.href);
  url.searchParams.delete("src");
  url.searchParams.set("data", enc);
  const final=url.toString();
  const box=document.getElementById("shareUrl");
  box.value=final;
  box.focus(); box.select();
}
function copyShare(){
  const box=document.getElementById("shareUrl");
  if(!box.value){ alert("è«‹å…ˆç”¢ç”Ÿåˆ†äº«é€£çµ"); return; }
  navigator.clipboard.writeText(box.value).then(()=>{
    alert("å·²è¤‡è£½åˆ†äº«é€£çµï¼");
  }).catch(()=>{
    box.focus(); box.select();
    alert("å·²é¸å–é€£çµï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚");
  });
}

/* ====== å•Ÿå‹•ï¼šæ”¯æ´ ?data= èˆ‡ ?src= ====== */
window.addEventListener("DOMContentLoaded", async () => {
  renderRecords();
  const data = getParam("data");
  const src  = getParam("src");
  const auto = getParam("auto"); // ?auto=1 è‡ªå‹•é–‹å§‹ï¼ˆçµ¦åˆ†äº«é€£çµç”¨ï¼‰

  if(data){
    try{
      const text = base64urlDecode(data);
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      quizData = shuffle(parseLinesToQuiz(lines));
      if(auto==="1"){
        startQuiz();
      }else{
        document.getElementById("wordInput").value = text;
      }
    }catch(e){
      console.error(e);
      alert("è®€å–é€£çµä¸­çš„é¡Œåº«å¤±æ•—ã€‚");
    }
  }else if(src){
    await loadFromSrcUrl(src);
  }
});
</script>
</body>
</html>
